<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº¤æ˜“è®°å½•</title>
    
    <!-- PWA / iOS App æ”¯æŒ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="äº¤æ˜“è®°å½•">
    <meta name="theme-color" content="#0a0a0a">
    <link rel="apple-touch-icon" href="icon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            color: #e0e0e0;
            padding-top: max(10px, env(safe-area-inset-top));
            padding-bottom: calc(70px + env(safe-area-inset-bottom));
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* é¡µé¢å†…å®¹ */
        .page {
            display: none;
            padding: 10px 0;
            animation: fadeIn 0.2s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: #141414;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 15px;
            border: 1px solid #222;
        }

        .card.compact {
            padding: 14px;
        }

        .card-title {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #252525;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card.compact .card-title {
            margin-bottom: 12px;
            padding-bottom: 10px;
        }

        /* æ¨ªå‘æ’åˆ—å®¹å™¨ */
        .card-row {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .card-row .card {
            flex: 1;
            margin-bottom: 0;
        }

        /* æ•°æ®ç®¡ç†æŒ‰é’®å‚ç›´æ’åˆ— */
        .btn-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group.compact {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #333;
            border-radius: 12px;
            background: #0a0a0a;
            color: #e0e0e0;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input.compact {
            padding: 12px 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #555;
        }

        .form-group input::placeholder {
            color: #555;
        }

        .form-group input:disabled {
            background: #1a1a1a;
            color: #666;
            cursor: not-allowed;
        }

        .hint-text {
            font-size: 0.75rem;
            color: #666;
            margin-top: 6px;
        }

        /* ç›ˆäºè¾“å…¥æ¡†ç»„ */
        .pnl-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .pnl-input-item {
            position: relative;
        }

        .pnl-input-item label {
            display: block;
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 6px;
        }

        .pnl-input-item.profit label {
            color: #4caf50;
        }

        .pnl-input-item.loss label {
            color: #f44336;
        }

        .pnl-input-item input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #333;
            border-radius: 10px;
            background: #0a0a0a;
            color: #e0e0e0;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .pnl-input-item.profit input {
            border-color: #2a3a2a;
        }

        .pnl-input-item.profit input:focus {
            border-color: #4caf50;
        }

        .pnl-input-item.loss input {
            border-color: #3a2a2a;
            padding-left: 28px;
        }

        .pnl-input-item.loss input:focus {
            border-color: #f44336;
        }

        .loss-prefix {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #f44336;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            min-height: 52px;
        }

        .btn.compact {
            padding: 12px;
            min-height: 44px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #fff;
            color: #000;
        }

        .btn-primary:active:not(:disabled) {
            background: #ccc;
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #252525;
            color: #e0e0e0;
        }

        .btn-secondary:active {
            background: #333;
        }

        .btn-danger {
            background: #2a1a1a;
            color: #ff6b6b;
            border: 1px solid #3a2020;
        }

        .btn-danger:active {
            background: #3a2020;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* æ¨¡å¼åˆ‡æ¢ */
        .mode-switch {
            display: flex;
            background: #0a0a0a;
            border-radius: 12px;
            padding: 4px;
            border: 1px solid #2a2a2a;
        }

        .mode-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: none;
            color: #666;
            cursor: pointer;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: #333;
            color: #fff;
        }

        /* å½“å‰ä½™é¢æ˜¾ç¤º */
        .current-balance {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 16px;
            border-radius: 14px;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid #252540;
        }

        .current-balance .label {
            color: #888;
            font-size: 0.8rem;
            margin-bottom: 6px;
        }

        .current-balance .value {
            color: #fff;
            font-size: 1.6rem;
            font-weight: 700;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .stats-grid-small {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .stat-card {
            background: #1a1a1a;
            padding: 10px 8px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #252525;
        }

        .stat-card.main {
            padding: 12px 10px;
        }

        .stat-label {
            font-size: 0.6rem;
            color: #666;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: #e0e0e0;
        }

        .stat-card.main .stat-value {
            font-size: 1rem;
        }

        .stat-value.positive { color: #4caf50; }
        .stat-value.negative { color: #f44336; }

        /* å›¾è¡¨ */
        .chart-container {
            position: relative;
            height: 320px;
            background: #0a0a0a;
            border-radius: 12px;
            margin-top: 10px;
        }

        #chartCanvas {
            width: 100%;
            height: 100%;
        }

        .chart-tabs {
            display: flex;
            gap: 6px;
        }

        .chart-tab {
            padding: 6px 12px;
            border: 1px solid #333;
            background: none;
            color: #666;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .chart-tab.active {
            background: #333;
            color: #fff;
            border-color: #444;
        }

        .chart-tooltip {
            position: absolute;
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 100;
            white-space: nowrap;
        }

        .chart-tooltip.show {
            opacity: 1;
        }

        .chart-tooltip .tt-label {
            color: #888;
            font-size: 0.7rem;
        }

        .chart-tooltip .tt-value {
            font-weight: 600;
            margin-top: 4px;
            font-size: 0.95rem;
        }

        /* è¡¨æ ¼ */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -18px;
            padding: 0 18px;
        }

        /* äº¤æ˜“è®°å½•è¡¨å¤´ */
        .trade-header {
            display: grid;
            grid-template-columns: 40px 1fr 70px 80px 1fr 44px;
            gap: 8px;
            padding: 10px 14px;
            background: #1a1a1a;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #252525;
            font-size: 0.75rem;
            color: #666;
            font-weight: 500;
        }

        .trade-header span {
            text-align: center;
        }

        .trade-header span:nth-child(2),
        .trade-header span:nth-child(5) {
            text-align: left;
        }

        .trade-header span:last-child {
            text-align: center;
        }

        .trade-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .trade-item {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 14px;
            display: grid;
            grid-template-columns: 40px 1fr 70px 80px 1fr 44px;
            gap: 8px;
            align-items: center;
            border: 1px solid #252525;
        }

        .trade-num {
            font-size: 0.75rem;
            color: #555;
            text-align: center;
        }

        .trade-pnl {
            font-size: 1rem;
            font-weight: 600;
        }

        .trade-pnl.profit { color: #4caf50; }
        .trade-pnl.loss { color: #f44336; }

        .trade-return {
            font-size: 0.85rem;
            text-align: center;
        }

        .trade-return.profit { color: #4caf50; }
        .trade-return.loss { color: #f44336; }

        .trade-balance {
            font-size: 0.8rem;
            color: #888;
            text-align: center;
        }

        .trade-note {
            font-size: 0.75rem;
            color: #888;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #555;
            cursor: pointer;
            font-size: 1.3rem;
            padding: 10px;
            border-radius: 8px;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:active {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #444;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 0.95rem;
        }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #141414;
            border-top: 1px solid #252525;
            display: flex;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 0;
            color: #666;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
            border: none;
            background: none;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-item.active {
            color: #fff;
        }

        .nav-item .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .nav-item .nav-label {
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 2px;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-nav {
            display: flex;
            gap: 10px;
            padding: 15px 0;
        }

        .top-nav-btn {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid #333;
            background: none;
            color: #666;
            cursor: pointer;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .top-nav-btn.active {
            background: #333;
            color: #fff;
            border-color: #444;
        }

        .top-nav-btn:active {
            transform: scale(0.98);
        }

        /* å¤§å±å¹•é€‚é… */
        @media (min-width: 768px) {
            body {
                padding-bottom: 0;
            }

            .container {
                max-width: 500px;
            }

            .bottom-nav {
                display: none;
            }

            .chart-container {
                height: 350px;
            }
        }

        /* å°å±å¹•é€‚é…å¡ç‰‡æ¨ªæ’ */
        @media (max-width: 400px) {
            .card-row {
                flex-direction: column;
            }
            
            .trade-header {
                grid-template-columns: 35px 1fr 60px 70px 60px 40px;
                font-size: 0.7rem;
                padding: 8px 10px;
            }
            
            .trade-item {
                grid-template-columns: 35px 1fr 60px 70px 60px 40px;
                padding: 12px 10px;
            }
            
            .trade-pnl {
                font-size: 0.9rem;
            }
            
            .trade-return {
                font-size: 0.8rem;
            }
            
            .trade-balance {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="top-nav">
            <button class="top-nav-btn active" id="topNavManage" onclick="switchPage('manage')">äº¤æ˜“ç®¡ç†</button>
            <button class="top-nav-btn" id="topNavData" onclick="switchPage('data')">äº¤æ˜“æ•°æ®</button>
        </div>

        <!-- äº¤æ˜“ç®¡ç†é¡µé¢ -->
        <div class="page active" id="pageManage">
            <!-- æ·»åŠ äº¤æ˜“ - æ”¾æœ€ä¸Šé¢ -->
            <div class="card">
                <div class="card-title">æ·»åŠ å•ç¬”äº¤æ˜“è®°å½•</div>
                
                <div class="current-balance">
                    <div class="label">å½“å‰èµ„äº§</div>
                    <div class="value" id="displayBalance">$100,000</div>
                </div>
                
                <div class="form-group">
                    <label>è¾“å…¥æ–¹å¼</label>
                    <div class="mode-switch">
                        <button class="mode-btn active" id="btnPnl" onclick="setMode('pnl')">ç›ˆäºé‡‘é¢</button>
                        <button class="mode-btn" id="btnBal" onclick="setMode('balance')">è´¦æˆ·ä½™é¢</button>
                    </div>
                </div>
                
                <div id="groupPnl">
                    <div class="form-group">
                        <label>è¾“å…¥ç›ˆåˆ©æˆ–äºæŸé‡‘é¢ï¼ˆäºŒé€‰ä¸€ï¼‰</label>
                        <div class="pnl-input-group">
                            <div class="pnl-input-item profit">
                                <label>ç›ˆåˆ©é‡‘é¢</label>
                                <input type="number" id="inputProfit" placeholder="è¾“å…¥ç›ˆåˆ©" inputmode="decimal">
                            </div>
                            <div class="pnl-input-item loss">
                                <label>äºæŸé‡‘é¢</label>
                                <span class="loss-prefix">-</span>
                                <input type="number" id="inputLoss" placeholder="è¾“å…¥äºæŸ" inputmode="decimal">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="groupBal" style="display:none;">
                    <label>äº¤æ˜“åè´¦æˆ·ä½™é¢</label>
                    <input type="number" id="inputBal" placeholder="è¾“å…¥å½“å‰è´¦æˆ·ä½™é¢" inputmode="decimal">
                </div>

                <div class="form-group">
                    <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="inputNote" placeholder="äº¤æ˜“å¤‡æ³¨...">
                </div>
                
                <button class="btn btn-primary" onclick="addTrade()">æ·»åŠ è®°å½•</button>
            </div>

            <!-- åˆå§‹è®¾ç½®å’Œæ•°æ®ç®¡ç†æ¨ªå‘å¹¶æ’ -->
            <div class="card-row">
                <!-- åˆå§‹è®¾ç½® -->
                <div class="card compact">
                    <div class="card-title">åˆå§‹è®¾ç½®</div>
                    <div class="form-group compact">
                        <label>åˆå§‹èµ„äº§</label>
                        <input type="number" id="initialCapital" value="100000" inputmode="decimal" class="compact">
                        <div class="hint-text" id="initialHint"></div>
                    </div>
                    <button class="btn btn-primary compact" id="btnSetInitial" onclick="setInitial()">ç¡®è®¤è®¾ç½®</button>
                </div>

                <!-- æ•°æ®ç®¡ç† -->
                <div class="card compact">
                    <div class="card-title">æ•°æ®ç®¡ç†</div>
                    <div class="btn-vertical">
                        <button class="btn btn-secondary compact" onclick="exportCSV()">å¯¼å‡ºæ•°æ®</button>
                        <button class="btn btn-danger compact" onclick="clearAll()">æ¸…ç©ºæ•°æ®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- äº¤æ˜“æ•°æ®é¡µé¢ -->
        <div class="page" id="pageData">
            <!-- ç»Ÿè®¡æ•°æ® -->
            <div class="card compact">
                <div class="card-title">äº¤æ˜“æ•°æ®</div>
                <div class="stats-grid">
                    <div class="stat-card main">
                        <div class="stat-label">å½“å‰èµ„äº§</div>
                        <div class="stat-value" id="statCapital">$100,000</div>
                    </div>
                    <div class="stat-card main">
                        <div class="stat-label">æ€»æ”¶ç›Šç‡</div>
                        <div class="stat-value" id="statReturn">0.00%</div>
                    </div>
                    <div class="stat-card main">
                        <div class="stat-label">æ€»ç›ˆäº</div>
                        <div class="stat-value" id="statPnl">$0</div>
                    </div>
                </div>
                <div class="stats-grid-small">
                    <div class="stat-card">
                        <div class="stat-label">æœ€å¤§å›æ’¤</div>
                        <div class="stat-value" id="statDrawdown">0.00%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">èƒœç‡</div>
                        <div class="stat-value" id="statWinRate">0.00%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç›ˆäºæ¯”</div>
                        <div class="stat-value" id="statRatio">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">äº¤æ˜“æ¬¡æ•°</div>
                        <div class="stat-value" id="statCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¹³å‡ç›ˆäº</div>
                        <div class="stat-value" id="statAvg">$0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ€å¤§è¿äº</div>
                        <div class="stat-value" id="statMaxLoss">0</div>
                    </div>
                </div>
            </div>

            <!-- å›¾è¡¨ -->
            <div class="card">
                <div class="card-title">
                    <span>æ›²çº¿å›¾</span>
                    <div class="chart-tabs">
                        <button class="chart-tab active" id="tabEquity" onclick="showChart('equity')">èµ„äº§</button>
                        <button class="chart-tab" id="tabReturn" onclick="showChart('return')">æ”¶ç›Šç‡</button>
                    </div>
                </div>
                <div class="chart-container" id="chartBox">
                    <canvas id="chartCanvas"></canvas>
                    <div class="chart-tooltip" id="tooltip">
                        <div class="tt-label"></div>
                        <div class="tt-value"></div>
                    </div>
                </div>
            </div>

            <!-- äº¤æ˜“è®°å½•åˆ—è¡¨ -->
            <div class="card">
                <div class="card-title">äº¤æ˜“è®°å½•</div>
                <!-- è¡¨å¤´ -->
                <div class="trade-header" id="tradeHeader" style="display: none;">
                    <span>#</span>
                    <span>ç›ˆäº</span>
                    <span>æ”¶ç›Šç‡</span>
                    <span>ä½™é¢</span>
                    <span>å¤‡æ³¨</span>
                    <span>æ“ä½œ</span>
                </div>
                <div class="trade-list" id="tradeList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <div class="empty-state-text">æš‚æ— äº¤æ˜“è®°å½•</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var initial = 100000;
        var trades = [];
        var mode = 'pnl';
        var chartType = 'equity';
        var initialLocked = false;
        var chartPoints = [];
        var currentPage = 'manage';

        function init() {
            load();
            updateInitialUI();
            render();
            bindChartEvents();
            bindPnlInputEvents();
        }

        function bindPnlInputEvents() {
            var profitInput = document.getElementById('inputProfit');
            var lossInput = document.getElementById('inputLoss');
            
            profitInput.addEventListener('input', function() {
                if (this.value !== '') {
                    lossInput.value = '';
                }
            });
            
            lossInput.addEventListener('input', function() {
                if (this.value !== '') {
                    profitInput.value = '';
                }
            });
        }

        function switchPage(page) {
            currentPage = page;
            
            document.getElementById('pageManage').classList.toggle('active', page === 'manage');
            document.getElementById('pageData').classList.toggle('active', page === 'data');
            
            document.getElementById('topNavManage').classList.toggle('active', page === 'manage');
            document.getElementById('topNavData').classList.toggle('active', page === 'data');
            
            if (page === 'data') {
                setTimeout(drawChart, 50);
            }
            
            window.scrollTo(0, 0);
        }

        function updateInitialUI() {
            var input = document.getElementById('initialCapital');
            var btn = document.getElementById('btnSetInitial');
            var hint = document.getElementById('initialHint');
            
            if (initialLocked) {
                input.disabled = true;
                btn.disabled = true;
                hint.textContent = 'æ¸…ç©ºæ•°æ®åå¯é‡æ–°è®¾ç½®';
            } else {
                input.disabled = false;
                btn.disabled = false;
                hint.textContent = '';
            }
        }

        function setMode(m) {
            mode = m;
            document.getElementById('btnPnl').className = m === 'pnl' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btnBal').className = m === 'balance' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('groupPnl').style.display = m === 'pnl' ? 'block' : 'none';
            document.getElementById('groupBal').style.display = m === 'balance' ? 'block' : 'none';
        }

        function showChart(type) {
            chartType = type;
            document.getElementById('tabEquity').className = type === 'equity' ? 'chart-tab active' : 'chart-tab';
            document.getElementById('tabReturn').className = type === 'return' ? 'chart-tab active' : 'chart-tab';
            drawChart();
        }

        function setInitial() {
            if (initialLocked) return;
            
            var val = parseFloat(document.getElementById('initialCapital').value);
            if (isNaN(val) || val <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆå§‹èµ„äº§');
                return;
            }
            initial = val;
            initialLocked = true;
            updateInitialUI();
            save();
            render();
        }

        function getBalance() {
            var bal = initial;
            for (var i = 0; i < trades.length; i++) {
                bal += trades[i].pnl;
            }
            return bal;
        }

        function addTrade() {
            if (!initialLocked) {
                alert('è¯·å…ˆç¡®è®¤è®¾ç½®åˆå§‹èµ„äº§');
                return;
            }
            
            var pnl, currentBal = getBalance();
            
            if (mode === 'pnl') {
                var profitVal = document.getElementById('inputProfit').value;
                var lossVal = document.getElementById('inputLoss').value;
                
                if (profitVal !== '' && !isNaN(parseFloat(profitVal))) {
                    pnl = Math.abs(parseFloat(profitVal));
                } else if (lossVal !== '' && !isNaN(parseFloat(lossVal))) {
                    pnl = -Math.abs(parseFloat(lossVal));
                } else {
                    alert('è¯·è¾“å…¥ç›ˆåˆ©é‡‘é¢æˆ–äºæŸé‡‘é¢');
                    return;
                }
            } else {
                var v = document.getElementById('inputBal').value;
                if (v === '' || isNaN(parseFloat(v))) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è´¦æˆ·ä½™é¢');
                    return;
                }
                pnl = parseFloat(v) - currentBal;
            }

            trades.push({
                id: Date.now(),
                pnl: pnl,
                note: document.getElementById('inputNote').value.trim(),
                before: currentBal
            });

            document.getElementById('inputProfit').value = '';
            document.getElementById('inputLoss').value = '';
            document.getElementById('inputBal').value = '';
            document.getElementById('inputNote').value = '';
            
            document.activeElement.blur();

            save();
            render();
            
            showToast('è®°å½•å·²æ·»åŠ ');
        }

        function showToast(msg) {
            var toast = document.createElement('div');
            toast.textContent = msg;
            toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#333;color:#fff;padding:12px 24px;border-radius:10px;z-index:9999;font-size:0.9rem;';
            document.body.appendChild(toast);
            setTimeout(function() {
                toast.style.transition = 'opacity 0.3s';
                toast.style.opacity = '0';
                setTimeout(function() { toast.remove(); }, 300);
            }, 1500);
        }

        function deleteTrade(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤ç¬”äº¤æ˜“è®°å½•ï¼Ÿ')) return;
            var newTrades = [];
            for (var i = 0; i < trades.length; i++) {
                if (trades[i].id !== id) newTrades.push(trades[i]);
            }
            trades = newTrades;
            recalc();
            save();
            render();
        }

        function recalc() {
            var bal = initial;
            for (var i = 0; i < trades.length; i++) {
                trades[i].before = bal;
                bal += trades[i].pnl;
            }
        }

        function getStats() {
            var s = {
                capital: initial,
                totalPnl: 0,
                totalReturn: 0,
                maxDD: 0,
                winRate: 0,
                ratio: 0,
                count: trades.length,
                avg: 0,
                maxConsecLoss: 0,
                equity: [initial],
                returns: [0]
            };

            if (trades.length === 0) return s;

            var bal = initial, peak = initial;
            var wins = 0, losses = 0, winSum = 0, lossSum = 0;
            var consec = 0, maxConsec = 0;

            for (var i = 0; i < trades.length; i++) {
                var t = trades[i];
                bal += t.pnl;
                s.equity.push(bal);
                s.returns.push((bal - initial) / initial * 100);

                if (t.pnl > 0) {
                    wins++;
                    winSum += t.pnl;
                    consec = 0;
                } else if (t.pnl < 0) {
                    losses++;
                    lossSum += Math.abs(t.pnl);
                    consec++;
                    if (consec > maxConsec) maxConsec = consec;
                } else {
                    consec = 0;
                }

                if (bal > peak) peak = bal;
                var dd = peak > 0 ? (peak - bal) / peak : 0;
                if (dd > s.maxDD) s.maxDD = dd;
            }

            s.capital = bal;
            s.totalPnl = bal - initial;
            s.totalReturn = (s.totalPnl / initial) * 100;
            s.maxDD = s.maxDD * 100;
            s.winRate = trades.length > 0 ? (wins / trades.length) * 100 : 0;
            s.avg = trades.length > 0 ? s.totalPnl / trades.length : 0;
            s.maxConsecLoss = maxConsec;

            var avgWin = wins > 0 ? winSum / wins : 0;
            var avgLoss = losses > 0 ? lossSum / losses : 0;
            s.ratio = avgLoss > 0 ? avgWin / avgLoss : (avgWin > 0 ? Infinity : 0);

            return s;
        }

        function fmt(v) {
            var prefix = v >= 0 ? '$' : '-$';
            return prefix + Math.abs(v).toLocaleString('en-US', {maximumFractionDigits: 0});
        }

        function render() {
            var s = getStats();

            document.getElementById('displayBalance').textContent = fmt(s.capital);
            document.getElementById('statCapital').textContent = fmt(s.capital);
            
            var retEl = document.getElementById('statReturn');
            retEl.textContent = s.totalReturn.toFixed(2) + '%';
            retEl.className = 'stat-value ' + (s.totalReturn >= 0 ? 'positive' : 'negative');

            var pnlEl = document.getElementById('statPnl');
            pnlEl.textContent = (s.totalPnl >= 0 ? '+' : '') + fmt(s.totalPnl);
            pnlEl.className = 'stat-value ' + (s.totalPnl >= 0 ? 'positive' : 'negative');

            var ddEl = document.getElementById('statDrawdown');
            ddEl.textContent = s.maxDD.toFixed(2) + '%';
            ddEl.className = 'stat-value' + (s.maxDD > 0 ? ' negative' : '');

            document.getElementById('statWinRate').textContent = s.winRate.toFixed(2) + '%';
            
            var ratioEl = document.getElementById('statRatio');
            ratioEl.textContent = s.ratio === Infinity ? 'âˆ' : (s.ratio === 0 && trades.length === 0 ? '-' : s.ratio.toFixed(2));

            document.getElementById('statCount').textContent = s.count;

            var avgEl = document.getElementById('statAvg');
            avgEl.textContent = (s.avg >= 0 ? '+' : '') + fmt(s.avg);
            avgEl.className = 'stat-value ' + (s.avg >= 0 ? 'positive' : 'negative');

            var lossEl = document.getElementById('statMaxLoss');
            lossEl.textContent = s.maxConsecLoss;
            lossEl.className = 'stat-value' + (s.maxConsecLoss > 0 ? ' negative' : '');

            if (currentPage === 'data') {
                drawChart();
            }
            renderTradeList();
        }

        function drawChart() {
            var canvas = document.getElementById('chartCanvas');
            var ctx = canvas.getContext('2d');
            var container = document.getElementById('chartBox');
            
            var dpr = window.devicePixelRatio || 1;
            var rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);

            var s = getStats();
            var data = chartType === 'equity' ? s.equity : s.returns;
            var threshold = chartType === 'equity' ? initial : 0;

            var w = rect.width;
            var h = rect.height;
            var pad = {t: 20, r: 15, b: 30, l: 60};
            var cw = w - pad.l - pad.r;
            var ch = h - pad.t - pad.b;

            ctx.clearRect(0, 0, w, h);
            chartPoints = [];

            if (data.length < 1) {
                ctx.fillStyle = '#444';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', w/2, h/2);
                return;
            }

            var minV = Math.min.apply(null, data);
            var maxV = Math.max.apply(null, data);
            var range = maxV - minV || 1;
            var yMin = minV - range * 0.1;
            var yMax = maxV + range * 0.1;

            ctx.strokeStyle = '#1e1e1e';
            ctx.lineWidth = 1;
            for (var i = 0; i <= 4; i++) {
                var y = pad.t + (ch / 4) * i;
                ctx.beginPath();
                ctx.moveTo(pad.l, y);
                ctx.lineTo(w - pad.r, y);
                ctx.stroke();

                var val = yMax - ((yMax - yMin) / 4) * i;
                ctx.fillStyle = '#555';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'right';
                var label = chartType === 'equity' ? fmt(val) : val.toFixed(1) + '%';
                ctx.fillText(label, pad.l - 8, y + 4);
            }

            if (yMin < threshold && yMax > threshold) {
                var ty = pad.t + ch * ((yMax - threshold) / (yMax - yMin));
                ctx.strokeStyle = '#333';
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(pad.l, ty);
                ctx.lineTo(w - pad.r, ty);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            var step = Math.max(1, Math.floor(data.length / 6));
            ctx.fillStyle = '#555';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            for (var i = 0; i < data.length; i += step) {
                var x = pad.l + (cw / Math.max(data.length - 1, 1)) * i;
                ctx.fillText(i.toString(), x, h - 10);
            }

            var pts = [];
            for (var i = 0; i < data.length; i++) {
                var x = pad.l + (cw / Math.max(data.length - 1, 1)) * i;
                var y = pad.t + ch * ((yMax - data[i]) / (yMax - yMin));
                var val = data[i];
                pts.push({x: x, y: y, val: val, idx: i});
                chartPoints.push({x: x, y: y, val: val, idx: i});
            }

            var lastVal = data[data.length - 1];
            var color = lastVal >= threshold ? '#4caf50' : '#f44336';

            ctx.beginPath();
            ctx.moveTo(pts[0].x, pad.t + ch);
            for (var i = 0; i < pts.length; i++) {
                ctx.lineTo(pts[i].x, pts[i].y);
            }
            ctx.lineTo(pts[pts.length-1].x, pad.t + ch);
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.15;
            ctx.fill();
            ctx.globalAlpha = 1;

            ctx.beginPath();
            ctx.moveTo(pts[0].x, pts[0].y);
            for (var i = 1; i < pts.length; i++) {
                ctx.lineTo(pts[i].x, pts[i].y);
            }
            ctx.strokeStyle = color;
            ctx.lineWidth = 2.5;
            ctx.stroke();

            for (var i = 0; i < pts.length; i++) {
                ctx.beginPath();
                ctx.arc(pts[i].x, pts[i].y, 5, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                ctx.strokeStyle = '#141414';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        function bindChartEvents() {
            var canvas = document.getElementById('chartCanvas');
            var tooltip = document.getElementById('tooltip');
            var container = document.getElementById('chartBox');

            function showTooltipAt(clientX, clientY) {
                var rect = canvas.getBoundingClientRect();
                var mx = clientX - rect.left;
                var my = clientY - rect.top;

                var found = null;
                var minDist = 40;

                for (var i = 0; i < chartPoints.length; i++) {
                    var p = chartPoints[i];
                    var dist = Math.sqrt((mx - p.x) * (mx - p.x) + (my - p.y) * (my - p.y));
                    if (dist < minDist) {
                        minDist = dist;
                        found = p;
                    }
                }

                if (found) {
                    var label = chartType === 'equity' ? 'èµ„äº§ä½™é¢' : 'ç´¯è®¡æ”¶ç›Šç‡';
                    var value = chartType === 'equity' ? fmt(found.val) : found.val.toFixed(2) + '%';
                    var valClass = chartType === 'equity' 
                        ? (found.val >= initial ? 'profit' : 'loss')
                        : (found.val >= 0 ? 'profit' : 'loss');

                    tooltip.querySelector('.tt-label').textContent = 'ç¬¬ ' + found.idx + ' ç¬” Â· ' + label;
                    tooltip.querySelector('.tt-value').textContent = value;
                    tooltip.querySelector('.tt-value').className = 'tt-value ' + valClass;
                    
                    var tx = found.x + 15;
                    var ty = found.y - 50;
                    if (tx + 120 > container.clientWidth) tx = found.x - 130;
                    if (ty < 0) ty = found.y + 15;

                    tooltip.style.left = tx + 'px';
                    tooltip.style.top = ty + 'px';
                    tooltip.classList.add('show');
                } else {
                    tooltip.classList.remove('show');
                }
            }

            canvas.addEventListener('mousemove', function(e) {
                showTooltipAt(e.clientX, e.clientY);
            });
            
            canvas.addEventListener('mouseleave', function() {
                tooltip.classList.remove('show');
            });

            canvas.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1) {
                    var touch = e.touches[0];
                    showTooltipAt(touch.clientX, touch.clientY);
                }
            }, {passive: true});

            canvas.addEventListener('touchmove', function(e) {
                if (e.touches.length === 1) {
                    var touch = e.touches[0];
                    showTooltipAt(touch.clientX, touch.clientY);
                }
            }, {passive: true});

            canvas.addEventListener('touchend', function() {
                setTimeout(function() {
                    tooltip.classList.remove('show');
                }, 2000);
            });
        }

        function renderTradeList() {
            var container = document.getElementById('tradeList');
            var header = document.getElementById('tradeHeader');
            
            if (trades.length === 0) {
                header.style.display = 'none';
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div class="empty-state-text">æš‚æ— äº¤æ˜“è®°å½•</div></div>';
                return;
            }

            header.style.display = 'grid';

            var html = '';
            var balances = [];
            var bal = initial;
            for (var i = 0; i < trades.length; i++) {
                bal += trades[i].pnl;
                balances.push(bal);
            }

            for (var i = trades.length - 1; i >= 0; i--) {
                var t = trades[i];
                var before = t.before !== undefined ? t.before : (i === 0 ? initial : balances[i - 1]);
                var after = balances[i];
                var ret = before > 0 ? (t.pnl / before * 100) : 0;
                var cls = t.pnl >= 0 ? 'profit' : 'loss';
                var sign = t.pnl >= 0 ? '+' : '';
                var rsign = ret >= 0 ? '+' : '';

                html += '<div class="trade-item">';
                html += '<div class="trade-num">' + (i + 1) + '</div>';
                html += '<div class="trade-pnl ' + cls + '">' + sign + fmt(t.pnl) + '</div>';
                html += '<div class="trade-return ' + cls + '">' + rsign + ret.toFixed(2) + '%</div>';
                html += '<div class="trade-balance">' + fmt(after) + '</div>';
                html += '<div class="trade-note">' + (t.note || '-') + '</div>';
                html += '<button class="delete-btn" onclick="deleteTrade(' + t.id + ')">Ã—</button>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function save() {
            localStorage.setItem('tradeData', JSON.stringify({
                initial: initial,
                trades: trades,
                locked: initialLocked
            }));
        }

        function load() {
            try {
                var d = localStorage.getItem('tradeData');
                if (d) {
                    var obj = JSON.parse(d);
                    initial = obj.initial || 100000;
                    trades = obj.trades || [];
                    initialLocked = obj.locked || false;
                    document.getElementById('initialCapital').value = initial;
                    recalc();
                }
            } catch(e) {}
        }

        function exportCSV() {
            var s = getStats();
            var csv = 'äº¤æ˜“è®°å½•åˆ†ææŠ¥å‘Š\n\n';
            csv += 'åˆå§‹èµ„äº§,' + initial + '\n';
            csv += 'å½“å‰èµ„äº§,' + s.capital + '\n';
            csv += 'æ€»æ”¶ç›Šç‡,' + s.totalReturn.toFixed(2) + '%\n';
            csv += 'æ€»ç›ˆäº,' + s.totalPnl + '\n';
            csv += 'æœ€å¤§å›æ’¤,' + s.maxDD.toFixed(2) + '%\n';
            csv += 'èƒœç‡,' + s.winRate.toFixed(2) + '%\n';
            csv += 'ç›ˆäºæ¯”,' + (s.ratio === Infinity ? 'æ— ç©·å¤§' : s.ratio.toFixed(2)) + '\n';
            csv += 'äº¤æ˜“æ¬¡æ•°,' + s.count + '\n';
            csv += 'æœ€å¤§è¿ç»­äºæŸ,' + s.maxConsecLoss + '\n\n';
            csv += 'åºå·,ç›ˆäº,æœ¬æ¬¡æ”¶ç›Šç‡,ä½™é¢,å¤‡æ³¨\n';

            var bal = initial;
            for (var i = 0; i < trades.length; i++) {
                var t = trades[i];
                var before = t.before !== undefined ? t.before : bal;
                bal = before + t.pnl;
                var ret = before > 0 ? (t.pnl / before * 100).toFixed(2) : '0.00';
                csv += (i+1) + ',' + t.pnl + ',' + ret + '%,' + bal + ',' + (t.note || '') + '\n';
            }

            var blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'äº¤æ˜“è®°å½•.csv';
            link.click();
            
            showToast('å¯¼å‡ºæˆåŠŸ');
        }

        function clearAll() {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                trades = [];
                initialLocked = false;
                updateInitialUI();
                save();
                render();
                showToast('æ•°æ®å·²æ¸…ç©º');
            }
        }

        var resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                if (currentPage === 'data') {
                    drawChart();
                }
            }, 100);
        });

        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                if (currentPage === 'data') {
                    drawChart();
                }
            }, 300);
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                var id = document.activeElement.id;
                if (id === 'inputProfit' || id === 'inputLoss' || id === 'inputBal' || id === 'inputNote') {
                    addTrade();
                }
            }
        });

        init();
    </script>
</body>
</html>

